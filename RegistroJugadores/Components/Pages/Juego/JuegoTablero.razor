@page "/"
@using RegistroJugadores.DTOs
@inject PartidasService partidasService
@inject JugadoresService jugadoresService
@inject NavigationManager navigationManager
@inject PartidasApiService partidasApi
@rendermode InteractiveServer
@implements IDisposable

<div class="container mx-auto max-w-lg p-6 bg-white rounded-lg shadow-xl text-center">

    <div class="mb-4 p-4 border rounded-lg">
        <h3 class="text-lg font-semibold">Cargar Partida desde API</h3>
        <div class="flex gap-2 justify-center">
            <InputNumber class="form-control w-24" @bind-Value="partidaIdParaCargar" placeholder="ID Partida" />
            <button class="btn btn-primary" @onclick="CargarJuego"
                    disabled="@(partidaIdParaCargar == null || partidaIdParaCargar == 0 || estaCargando)">
                @if (estaCargando)
                {
                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                }
                else
                {
                    <span>Cargar</span>
                }
            </button>
        </div>
        @if (errorApi != null)
        {
            <p class="text-danger mt-2">@errorApi</p>
        }
    </div>

    @if (partidaIdActual != null)
    {
        @if (!simboloElegido)
        {
            <div class="mb-4 p-4 border rounded-lg">
                <h3 class="text-lg font-semibold">¿Con qué símbolo quieres jugar esta partida?</h3>
                <div class="flex gap-4 justify-center mt-2">
                    <button class="btn btn-primary" style="font-size: 1.5rem; width: 80px;" @onclick="@(() => ElegirSimbolo("X"))">
                        X
                    </button>
                    <button class="btn btn-info" style="font-size: 1.5rem; width: 80px; color: white;" @onclick="@(() => ElegirSimbolo("O"))">
                        O
                    </button>
                </div>
            </div>
        }
        else
        {
            <div class="game-container">
                <div class="game-screen">
                    <h2 class="game-status">@GameStatus</h2>
                    <div class="game-board">
                        @for (var i = 0; i < 9; i++)
                        {
                            var cellIndex = i;
                            <button class="cell @GetPlayerClass(board[cellIndex])"
                                    @onclick="() => HandleCellClick(cellIndex)"
                                    disabled="@(board[cellIndex] != null || juegoTerminado || jugadorActual != simboloJugadorActual || estaCargando)">
                                @board[cellIndex]?.ToString()
                            </button>
                        }
                    </div>
                </div>
            </div>
        }
    }
    else if (!estaCargando)
    {
        <p>Por favor, ingrese un ID de partida y presione "Cargar".</p>
    }
</div>

@code {
    private int? partidaIdParaCargar;
    private int? partidaIdActual;
    private bool estaCargando = false;
    private string? errorApi;

    private PartidasResponse? partidaInfo;
    private List<MovimientoResponse> movimientosApi = new();
    private string?[] board = new string?[9];
    private string jugadorActual = "X";
    private bool juegoTerminado = false;

    private string? simboloJugadorActual;
    private bool simboloElegido = false;

    private System.Threading.Timer? _gameTimer;

    private async Task CargarJuego()
    {
        if (partidaIdParaCargar == null || partidaIdParaCargar == 0) return;

        estaCargando = true;
        errorApi = null;
        simboloElegido = false;
        simboloJugadorActual = null;
        partidaIdActual = null;
        movimientosApi.Clear();
        partidaInfo = null;

        _gameTimer?.Dispose();

        try
        {
            partidaInfo = await partidasApi.ObtenerPartidaAsync(partidaIdParaCargar.Value);

            if (partidaInfo == null)
            {
                errorApi = $"La Partida ID {partidaIdParaCargar.Value} no existe en la API.";
                return;
            }

            if (!partidaInfo.Jugador2Id.HasValue)
            {
                errorApi = "Esta partida aún está esperando al Jugador 2. No se pueden registrar movimientos.";
                return;
            }

            var movimientos = await partidasApi.ObtenerMovimientosAsync(partidaIdParaCargar.Value);

            if (movimientos == null)
            {
                errorApi = "Error de conexión: No se pudo contactar la API para obtener los movimientos.";
                partidaInfo = null;
            }
            else
            {
                partidaIdActual = partidaIdParaCargar;
                movimientosApi = movimientos;
                ReconstruirTableroDesdeApi();
                DeterminarEstadoJuego();
            }
        }
        catch (Exception ex)
        {
            errorApi = $"Error inesperado: {ex.Message}";
        }
        finally
        {
            estaCargando = false;
        }
    }

    private void ElegirSimbolo(string simbolo)
    {
        simboloJugadorActual = simbolo;
        simboloElegido = true;

        _gameTimer = new System.Threading.Timer(ActualizarEstado, null, 3000, 3000);

        StateHasChanged();
    }

    private async void ActualizarEstado(object? state)
    {
        if (estaCargando || !partidaIdActual.HasValue || juegoTerminado)
        {
            return;
        }

        await InvokeAsync(async () =>
        {
            if (estaCargando || !partidaIdActual.HasValue || juegoTerminado)
            {
                return;
            }

            try
            {
                var nuevosMovimientos = await partidasApi.ObtenerMovimientosAsync(partidaIdActual.Value);

                if (nuevosMovimientos != null && nuevosMovimientos.Count != movimientosApi.Count)
                {
                    movimientosApi = nuevosMovimientos;
                    ReconstruirTableroDesdeApi();
                    DeterminarEstadoJuego();
                    StateHasChanged();
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error en timer de refresco: {ex.Message}");
            }
        });
    }

    private void ReconstruirTableroDesdeApi()
    {
        board = new string?[9];
        foreach (var mov in movimientosApi.OrderBy(m => m.MovimientoId))
        {
            int index = (mov.PosicionFila * 3) + mov.PosicionColumna;
            if (index >= 0 && index < 9)
            {
                board[index] = mov.Jugador;
            }
        }
    }

    private void DeterminarEstadoJuego()
    {
        int numeroDeMovimientos = movimientosApi.Count;
        jugadorActual = (numeroDeMovimientos % 2 == 0) ? "X" : "O";

        var ganador = CheckForWinner();
        if (ganador != null)
        {
            juegoTerminado = true;
            _gameTimer?.Change(Timeout.Infinite, Timeout.Infinite);
        }
        else if (numeroDeMovimientos >= 9)
        {
            juegoTerminado = true;
            _gameTimer?.Change(Timeout.Infinite, Timeout.Infinite);
        }
        else
        {
            juegoTerminado = false;
        }
    }

    private async Task HandleCellClick(int index)
    {
        errorApi = null;
        if (jugadorActual != simboloJugadorActual)
        {
            errorApi = "¡Espera! No es tu turno.";
            return;
        }
        if (board[index] != null || juegoTerminado || !partidaIdActual.HasValue || estaCargando || partidaInfo == null)
        {
            return;
        }
        if (!partidaInfo.Jugador2Id.HasValue)
        {
            errorApi = "No se puede jugar, falta el Jugador 2.";
            return;
        }

        estaCargando = true; 

        try 
        {
            (int fila, int col) = (index / 3, index % 3);
            var request = new MovimientoRequest
            {
                PartidaId = partidaIdActual.Value,
                Jugador = jugadorActual,
                PosicionFila = fila,
                PosicionColumna = col
            };

            var respuestaApi = await partidasApi.EnviarMovimientoAsync(request);

            if (respuestaApi == null)
            {
                errorApi = "La API rechazó el movimiento. (¿Casilla ocupada? ¿Turno incorrecto?)";
            }
            else
            {
                movimientosApi.Add(respuestaApi);
                board[index] = respuestaApi.Jugador;
                DeterminarEstadoJuego();
            }
        }
        finally
        {
            estaCargando = false;
            StateHasChanged();
        }
    }

    private string GameStatus
    {
        get
        {
            if (juegoTerminado)
            {
                var ganador = CheckForWinner();
                return ganador != null ? $"🏆 ¡Ganador: {ganador}!" : "🤝 ¡Es un empate!";
            }
            if (simboloJugadorActual == jugadorActual)
            {
                return $"¡Es tu turno! Juegas como: {jugadorActual}";
            }
            else
            {
                return $"Esperando al Jugador {jugadorActual}... (Tú juegas como {simboloJugadorActual})";
            }
        }
    }

    private string? CheckForWinner()
    {
        var winningLines = new[]
        {
            new[] {0, 1, 2}, new[] {3, 4, 5}, new[] {6, 7, 8},
            new[] {0, 3, 6}, new[] {1, 4, 7}, new[] {2, 5, 8},
            new[] {0, 4, 8}, new[] {2, 4, 6}
        };

        foreach (var line in winningLines)
        {
            var (a, b, c) = (line[0], line[1], line[2]);
            if (board[a] != null && board[a] == board[b] && board[a] == board[c])
            {
                return board[a];
            }
        }
        return null;
    }

    private string GetPlayerClass(string? player)
    {
        if (player == null) return "";
        return player == "X" ? "player-x" : "player-o";
    }

    public void Dispose()
    {
        _gameTimer?.Dispose();
    }
}